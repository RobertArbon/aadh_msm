* Heat the HIS dimer to 310K
*

stream toppar_water_ions_fixed.str
read rtf card name top_all36_prot.rtf append flex
read para card name par_all36_prot.prm append flex

set molname his-dimer-final

read psf card name @molname.psf
read coor card name @molname.cor

coordinate statistics select all end

calc xdim = abs ( ?XMAX - ?XMIN )
calc ydim = abs ( ?YMAX - ?YMIN )
calc zdim = abs ( ?ZMAX - ?ZMIN )

coor trans xdir @xdim ydir @ydim zdir @zdim factor 0.5

!
! Setup crystal
!
coordinate statistics select all end
calc cen @xdim/2

set length @xdim 
calc cutoff @length/2
CRYSTAL DEFI cubic @length @length @length 90.0 90.0 90.0
CRYSTAL BUILD cutoff @cutoff noper 0
IMAGE BYRES SELE SEGID BWAT END
image bysegid xcen @cen ycen @cen zcen @cen sele segid his2 end
image byres xcen @cen ycen @cen zcen @cen sele .not. (segid his2 .or. segid bwat) end

set ftx 36 
set fty 36 
set ftz 36 
NBONDED inbfrq -1 imgfrq -1 nbxmod 5 -                                              ! C36 DEFAULTS
        atom cdiel fshift -                                                         ! use atom based electrostatics, C36 DEFAULTS
        vatom vdistance vfswitch -                                                  ! C36 DEFAULTS
        elec ewald pmew fftx @ftx ffty @fty fftz @ftz kappa .34 spline order 6 -    ! PME SUMMATION
        cutnb 14.0 ctofnb 12.0 ctonnb 10.0 -                                        ! C36 DEFAULTS
        cutim @cutoff -                                                                ! must be same as cutnb
        eps 1.0 e14fac 1.0 wmin 1.5


energy omm


set nsteps = 10

!  turn on faster options and set-up SHAKE
faster on

shake fast bonh tol 1.0e-8 para 

set echeck = echeck -1

open unit 20 write form name restart.res

coor copy comp second
coor copy comp 

coordinate statistics select all end
coordinate statistics comp select all end
coordinate statistics comp second select all end

write coor card name before.cor
* Before dynamices
*

coor print unit 6 comp second sele ires 3 end
coor print unit 6 sele ires 3 end
coor rms comp second sele ires 3 end

! Run NVE dynamics, write restart file
calc nwrite = int ( @nsteps / 10 )
! Run dynamics in periodic box
dynamics leap start timestep 0.002 -
     nstep @nsteps nprint @nwrite iprfrq @nwrite isvfrq @nsteps iunwri 20 -
     firstt 298 finalt 298  -
     ichecw 0 ihtfrq 0 ieqfrq 0 -
     iasors 1 iasvel 1 iscvel 0  -
     ilbfrq 0 inbfrq -1 imgfrq -1 @echeck bycb -
     ntrfq @nsteps - !PME
     omm ! Just turn on openMM, get Leapfrog Verlet, NVE


write coor card name after.cor
* After dynamices
*
coordinate statistics select all end
coordinate statistics comp select all end
coordinate statistics comp second select all end

coor print unit 6 comp second sele ires 3 end
coor print unit 6 sele ires 3 end
coor rms comp second sele ires 1 end
coor rms comp second sele ires 3 end
coor rms comp second sele ires 1412 end
