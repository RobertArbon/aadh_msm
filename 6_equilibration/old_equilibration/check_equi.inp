* Final heating using serial code
*

envi OPENMM_PLATFORM  "CUDA"   ! /CUDA/Reference   Use OpenMM platform based on 
envi OPENMM_PRECISION "mixed"   ! /mixed/double    Do calculations in single 

stream /panfs/panasas01/chem/ra15808/aadh/setup.inp

prnlev 5

set buildcrystal ../common/build_crystal.str
set imaging ../common/set_images.str
set nonbondspec ../common/non_bond_spec.str

stream @charmmtop/toppar_water_ions_fixed.str
read rtf card name @charmmtop/top_all36_prot.rtf append flex
read rtf card name /panfs/panasas01/chem/ra15808/aadh/data/ra/aadh_topologies.rtf append flex
read para card name @charmmtop/par_all36_prot_mod.prm append flex
read para card name @datadir/ra/aadh_parameters.prm append flex

read psf card name ../common/2agy_final_min.psf
read coord card name 2agy-310k-1atm-equil.cor

stream crys_params.str

faster on
shake fast bonh tol 1.0e-8 para 

ioform extended
set niter 200 
set nsteps 500 
set ctr 1
set gamma 1
set nwrite 500
 
set echeck = echeck -1

set oldrestart 2agy-310k-1atm-equil.res

label loop
    set newrestart 2agy-310k-1atm-equi-step@ctr.res
    open read card unit 10 name @oldrestart
    open write card unit 11 name @newrestart
 
    dynamics leap restart timestep 0.002 -
         nstep @nsteps nprint @nsteps iprfrq @nsteps isvfrq @nsteps iunwri 11 iunread 10 - 
         firstt 310 finalt 310  -
         ichecw 0 ihtfrq 0 ieqfrq 0 -
         iasors 1 iasvel 1 iscvel 0  -
         ilbfrq 0 inbfrq -1 imgfrq -1 @echeck bycb -
         ntrfq 100 - 
         omm langevin gamma @gamma prmc pref 1.0 iprsfrq 25
    
    energy
         
    press insta
    press insta temp 310
 
    set oldrestart @oldrestart
  
    write coord card name 2agy-310k-1atm-equi-step@ctr.cor
    * Coordinates after @ctr equilibration steps
    * 

    incr ctr by 1
    if @ctr .le. @niter then goto loop

stop
